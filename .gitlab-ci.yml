image: openjdk:13-slim

before_script:
#  - apk add --no-cache make git
  - apt-get update && apt-get install -y make curl git jq
  - export GRADLE_USER_HOME=`pwd`/.gradle
  - chmod +x gradlew

cache:
  key: "${CI_BUILD_REF_NAME}"
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - .gradle/build-cache

stages:
  - compile
  - unit test
  - package
  - quality
  # - publish
  - trigger_main_pipeline
#  - trigger_deploy

assemble:
  stage: compile
  script:
    - make core-clean-assemble
  artifacts:
    paths:
#      - .gradle
      - build/
      - application/**/build/
      - domain/**/build/
      - infrastructure/**/build/
      - shared/**/build/
  allow_failure: false
  tags:
    - java

unit-test:
  stage: unit test
  dependencies:
    - assemble
  script:
    - make core-test
  artifacts:
    paths:
#      - .gradle
      - build/
      - application/**/build/
      - domain/**/build/
      - infrastructure/**/build/
      - shared/**/build/
  allow_failure: false
  tags:
    - java

package:
  stage: package
  only:
    - master
    - develop
  dependencies:
    - unit-test
  script:
    - make core-package
  artifacts:
    paths:
      - application/authentication-keycloak/build/
  allow_failure: false
  tags:
    - java

code-analysis:
  stage: quality
  image: ciricihq/gitlab-sonar-scanner
  variables:
    SONAR_URL: https://ci.tricefal.io/sonar
    SONAR_ANALYSIS_MODE: publish
    SONAR_TOKEN: f1843a5c58e6658ed82e95e169868d014e1d04b1
  only:
    - master
    - develop
  script:
    - gitlab-sonar-scanner
  dependencies:
    - unit-test
  when: on_success

#sonarqube-check:
#  stage: quality
#  image:
#    name: sonarsource/sonar-scanner-cli:latest
#    entrypoint: [""]
#  variables:
#    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
#    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
#  cache:
#    key: "${CI_JOB_NAME}"
#    paths:
#      - .sonar/cache
#  script:
#    - sonar-scanner -Dsonar.qualitygate.wait=true
#  allow_failure: true
#  only:
#    - master
#    - develop
#  dependencies:
#    - unit-test
#  when: on_success

trigger_main_pipeline:
  stage: trigger_main_pipeline
  variables:
    MAIN_PROJECT_ID: 18283923
  script:
    - curl -s -X POST -F token=$CI_JOB_TOKEN -F ref=develop -F "variables[TRIGGERER_PIPELINE_ID]=${CI_PIPELINE_ID}" https://gitlab.com/api/v4/projects/${MAIN_PROJECT_ID}/trigger/pipeline | tee res.json
    - cat res.json
  artifacts:
    paths:
      - res.json
  dependencies:
    - code-analysis
#    - package

after_script:
  - echo "End CI"